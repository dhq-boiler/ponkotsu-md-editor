<div class="container mt-4">
  <h1>Ponkotsu Markdown Editor - Bold Function Test (Real Gem)</h1>

  <div class="alert alert-info">
    <h4>ğŸ¯ å®Ÿéš›ã®gemã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆç’°å¢ƒ</h4>
    <p>ã“ã®ç’°å¢ƒã§ã¯ã€å®Ÿéš›ã®ponkotsu-md-editorã®gemã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚</p>
    <ul>
      <li>âœ… å®Ÿéš›ã®Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒ</li>
      <li>âœ… å®Ÿéš›ã®gemã®JavaScriptãƒ»CSS</li>
      <li>âœ… å®Ÿéš›ã®ERBãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</li>
      <li>âœ… æœ¬ç•ªã¨åŒã˜DOMã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†</li>
    </ul>
  </div>

  <%= form_with url: test_path, local: true, html: { class: "card" } do |form| %>
    <div class="card-body">
      <h3 class="card-title">ã‚¨ãƒ‡ã‚£ã‚¿ãƒ†ã‚¹ãƒˆ</h3>

      <%= markdown_editor(form: form, content: @content, options: {
        lang: :ja,
        preview: true,
        tools: %w[bold italic strikethrough heading1 heading2 heading3 heading4 heading5 heading6 unordered_list ordered_list check_list blockquote link image code code_block table horizontal_rule]
      }) %>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-floppy"></i> ä¿å­˜ã—ã¦ãƒ†ã‚¹ãƒˆ
        </button>

        <button type="button" class="btn btn-success" onclick="runBoldTests()">
          <i class="bi bi-play-circle"></i> Boldæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        </button>

        <button type="button" class="btn btn-warning" onclick="showEditorInfo()">
          <i class="bi bi-info-circle"></i> ã‚¨ãƒ‡ã‚£ã‚¿æƒ…å ±è¡¨ç¤º
        </button>

        <button type="button" class="btn btn-danger" onclick="clearEditorContent()">
          <i class="bi bi-trash"></i> ã‚¨ãƒ‡ã‚£ã‚¿ã‚¯ãƒªã‚¢
        </button>
      </div>
    </div>
  <% end %>

  <!-- ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div class="card mt-4">
    <div class="card-body">
      <h3 class="card-title">ãƒ†ã‚¹ãƒˆçµæœ</h3>
      <div id="testResults">
        <p class="text-muted">ã€ŒBoldæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    </div>
  </div>

  <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div class="card mt-4">
    <div class="card-body">
      <h3 class="card-title">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
      <div id="debugInfo" class="font-monospace small bg-light p-3 rounded">
        ã‚¨ãƒ‡ã‚£ã‚¿æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
      </div>
    </div>
  </div>
</div>

<script>
// å®Ÿéš›ã®gemã®JavaScriptã¨é€£æºã™ã‚‹ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
document.addEventListener('DOMContentLoaded', function() {
    console.log('Ponkotsu Markdown Editor Test Page Loaded');

    // ã‚¨ãƒ‡ã‚£ã‚¿è¦ç´ ã‚’å–å¾—
    const editor = document.getElementById('editor_content');
    if (editor) {
        console.log('Editor found:', editor);

        // åˆæœŸçŠ¶æ…‹ã®æƒ…å ±ã‚’è¡¨ç¤º
        showEditorInfo();

        // ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        editor.addEventListener('input', function() {
            showEditorInfo();
        });

        editor.addEventListener('mouseup', function() {
            showEditorInfo();
        });

        editor.addEventListener('keyup', function() {
            showEditorInfo();
        });
    } else {
        console.error('Editor not found');
    }
});

// ã‚¨ãƒ‡ã‚£ã‚¿æƒ…å ±è¡¨ç¤º
function showEditorInfo() {
    const editor = document.getElementById('editor_content');
    const debugDiv = document.getElementById('debugInfo');

    if (!editor || !debugDiv) return;

    const selection = window.getSelection();
    let selectionInfo = 'No selection';

    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const selectedText = range.toString();

        // é¸æŠç¯„å›²ã®ä½ç½®ã‚’è¨ˆç®—
        const beforeRange = document.createRange();
        beforeRange.selectNodeContents(editor);
        beforeRange.setEnd(range.startContainer, range.startOffset);
        const startPos = beforeRange.toString().length;

        const upToEndRange = document.createRange();
        upToEndRange.selectNodeContents(editor);
        upToEndRange.setEnd(range.endContainer, range.endOffset);
        const endPos = upToEndRange.toString().length;

        selectionInfo = `é–‹å§‹: ${startPos}, çµ‚äº†: ${endPos}, é•·ã•: ${selectedText.length}, ãƒ†ã‚­ã‚¹ãƒˆ: "${selectedText}"`;
    }

    debugDiv.innerHTML = `
        <strong>ã‚¨ãƒ‡ã‚£ã‚¿æƒ…å ±:</strong><br>
        å…¨ä½“ãƒ†ã‚­ã‚¹ãƒˆé•·: ${editor.innerText.length}<br>
        é¸æŠç¯„å›²: ${selectionInfo}<br>
        innerHTMLé•·: ${editor.innerHTML.length}<br>
        <strong>å®Ÿéš›ã®gemãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ âœ“</strong><br>
        <small>æ›´æ–°æ™‚åˆ»: ${new Date().toLocaleTimeString()}</small>
    `;
}

// Boldæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
function runBoldTests() {
    const resultsDiv = document.getElementById('testResults');
    const editor = document.getElementById('editor_content');

    if (!editor) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">ã‚¨ãƒ‡ã‚£ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
        return;
    }

    resultsDiv.innerHTML = '<div class="alert alert-info">ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...</div>';

    const tests = [
        {
            name: 'æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã®Boldé©ç”¨ãƒ†ã‚¹ãƒˆ',
            setup: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆã§ã™ã€‚\næ”¹è¡ŒãŒã‚ã‚Šã¾ã™ã€‚',
            action: function() {
                // "ãƒ†ã‚¹ãƒˆ"ã‚’é¸æŠã—ã¦Boldé©ç”¨
                const text = editor.innerText;
                const target = 'ãƒ†ã‚¹ãƒˆ';
                const startPos = text.indexOf(target);
                if (startPos >= 0) {
                    setSelectionRange(editor, startPos, startPos + target.length);
                    // å®Ÿéš›ã®gemã®Boldé–¢æ•°ã‚’å‘¼ã³å‡ºã—
                    if (window.applyBold) {
                        window.applyBold();
                        return true;
                    } else if (window.insertMarkdown) {
                        window.insertMarkdown('**', '**');
                        return true;
                    }
                }
                return false;
            },
            expected: 'ã“ã‚Œã¯**ãƒ†ã‚¹ãƒˆ**ã§ã™ã€‚\næ”¹è¡ŒãŒã‚ã‚Šã¾ã™ã€‚'
        },
        {
            name: 'æ”¹è¡Œã‚’ã¾ãŸãBoldé©ç”¨ãƒ†ã‚¹ãƒˆ',
            setup: 'ä¸€è¡Œç›®ã§ã™ã€‚\näºŒè¡Œç›®ã§ã™ã€‚',
            action: function() {
                // "ã§ã™ã€‚\näºŒ"ã‚’é¸æŠã—ã¦Boldé©ç”¨
                const text = editor.innerText;
                const startPos = text.indexOf('ã§ã™ã€‚');
                if (startPos >= 0) {
                    setSelectionRange(editor, startPos, startPos + 5); // "ã§ã™ã€‚\näºŒ"
                    if (window.applyBold) {
                        window.applyBold();
                        return true;
                    } else if (window.insertMarkdown) {
                        window.insertMarkdown('**', '**');
                        return true;
                    }
                }
                return false;
            },
            expected: 'ä¸€è¡Œç›®**ã§ã™ã€‚\näºŒ**è¡Œç›®ã§ã™ã€‚'
        }
    ];

    let results = '<h4>Boldæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆçµæœ</h4>';
    let passCount = 0;

    tests.forEach((test, index) => {
        // ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        editor.innerText = test.setup;
        editor.focus();

        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        const success = test.action();

        // çµæœç¢ºèª
        const actual = editor.innerText;
        const passed = actual === test.expected;

        if (passed) passCount++;

        results += `
            <div class="alert ${passed ? 'alert-success' : 'alert-danger'}">
                <strong>${test.name}</strong>: ${passed ? 'âœ… PASS' : 'âŒ FAIL'}<br>
                <small>æœŸå¾…å€¤: "${test.expected}"</small><br>
                <small>å®Ÿéš›å€¤: "${actual}"</small><br>
                <small>å®Ÿè¡ŒæˆåŠŸ: ${success ? 'Yes' : 'No'}</small>
            </div>
        `;
    });

    results += `<div class="alert alert-info"><strong>çµæœ: ${passCount}/${tests.length} ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ</strong></div>`;
    resultsDiv.innerHTML = results;

    // ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã€ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
    setTimeout(() => {
        editor.innerText = 'content content content\ncontent content content\n\n\ncontent content content\n\n\ncontent content content';
        showEditorInfo();
    }, 1000);
}

// ãƒ†ã‚­ã‚¹ãƒˆé¸æŠãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function setSelectionRange(element, start, end) {
    element.focus();

    const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        null,
        false
    );

    const textNodes = [];
    let node;
    while (node = walker.nextNode()) {
        textNodes.push(node);
    }

    let currentPos = 0;
    let startNode = null, startOffset = 0;
    let endNode = null, endOffset = 0;

    for (let i = 0; i < textNodes.length; i++) {
        const textNode = textNodes[i];
        const nodeLength = textNode.textContent.length;

        if (!startNode && currentPos + nodeLength >= start) {
            startNode = textNode;
            startOffset = start - currentPos;
        }

        if (!endNode && currentPos + nodeLength >= end) {
            endNode = textNode;
            endOffset = end - currentPos;
            break;
        }

        currentPos += nodeLength;
    }

    if (startNode && endNode) {
        try {
            const range = document.createRange();
            range.setStart(startNode, startOffset);
            range.setEnd(endNode, endOffset);

            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        } catch (e) {
            console.error('Selection failed:', e);
        }
    }
}

// ã‚¨ãƒ‡ã‚£ã‚¿ã‚¯ãƒªã‚¢
function clearEditorContent() {
    const editor = document.getElementById('editor_content');
    if (editor) {
        editor.innerText = '';
        showEditorInfo();
    }
}
</script>
